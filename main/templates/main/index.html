{% extends 'base.html' %}

{% block title %}대시보드{% endblock %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'main/css/main.css' %}">

<!-- <script src='https://cdn.jsdelivr.net/npm/rrule@2.6.4/dist/es5/rrule.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.11/index.global.min.js'></script> -->

<link href='https://unpkg.com/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
<script src='https://unpkg.com/fullcalendar@5.11.0/main.min.js'></script>
<script src='https://unpkg.com/fullcalendar@5.11.0/locales/ko.js'></script>
<style>
    .fc-button {
        background-color: #009879 !important;
        border-color: #009879 !important;
    }
</style>
<script>
    $(document).ready(function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            headerToolbar: {
                left: 'prev',
                center: 'title',
                right: 'next'
            },
            events: function (fetchInfo, successCallback, failureCallback) {
                var start = fetchInfo.startStr;
                var end = fetchInfo.endStr;
                start = formatDate(new Date(fetchInfo.startStr));
                end = formatDate(new Date(fetchInfo.endStr));

                $.ajax({
                    url: '/get_calendar/' + start + '/' + end,
                    method: 'GET',
                    beforeSend: function () {
                    },
                    success: function (data) {
                        var events = data.map(function (item) {
                            returnData = {
                                start: item.date,
                                allDay: true
                            }
                            if (item.type === "<class 'counseling.models.Log'>") {
                                returnData['title'] = "상담 " + item.count + '건'
                                returnData['backgroundColor'] = '#2ec4b6'
                                returnData['borderColor'] = '#2ec4b6'
                                returnData['textColor'] = 'black'
                            } else if (item.type === "<class 'education.models.Log'>") {
                                returnData['title'] = "트레이닝 " + item.count + '건'
                                returnData['backgroundColor'] = '#9ec5fe'
                                returnData['borderColor'] = '#9ec5fe'
                                returnData['textColor'] = 'black'
                            } else {
                                returnData['title'] = "퀴즈 " + item.count + '건'
                                returnData['backgroundColor'] = '#58b0e3'
                                returnData['borderColor'] = '#58b0e3'
                                returnData['textColor'] = 'black'
                            }
                            return returnData;
                        });
                        successCallback(events);
                    },
                    error: function () {
                        failureCallback();
                    },
                    complete: function () {
                    }

                });
            },
            eventClick: function (info) {
                var flag = info.event.title.split(" ")[0]
                var date = new Date(info.event.start);
                date = formatDate(new Date(info.event.start));
                console.log(date);

                if (flag === "상담") {
                    window.location.href = "{% url 'counseling:history' %}?startDate=" + date + "&endDate=" + date;
                } else if (flag === "퀴즈") {
                    window.location.href = "{% url 'education:quiz_history' %}?startDate=" + date + "&endDate=" + date;
                } else {
                    window.location.href = "{% url 'education:edu_history' %}?startDate=" + date + "&endDate=" + date;
                }
            }
        });
        calendar.render();
    });
    function formatDate(date) {
        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + date.getDate()).slice(-2);

        return year + '-' + month + '-' + day;
    }
</script>

<div class="dashboard dashboard-content">
    <div id="calendar" class="announcement-section calendar">
        {{data}}
    </div>
    <div class="announcement-section notice">
        <h2>공지 사항</h2>
        <ul>
            {% for notice in notices %}
            <li>
                <a href="{% url 'main:notice_detail' notice.id %}">{{ notice.title }}</a>
                <span>{{ notice.create_time|date:"Y.m.d" }}</span>
            </li>
            {% empty %}
            <li>등록된 공지 사항이 없습니다.</li>
            {% endfor %}
        </ul>
        <div class="pagination">
            <span class="step-links">
                {% if notices.has_previous %}
                <a href="?page=1">&laquo; 처음</a>
                <a href="?page={{ notices.previous_page_number }}">이전</a>
                {% endif %}

                <span class="current">
                    Page {{ notices.number }} of {{ notices.paginator.num_pages }}.
                </span>

                {% if notices.has_next %}
                <a href="?page={{ notices.next_page_number }}">다음</a>
                <a href="?page={{ notices.paginator.num_pages }}">마지막 &raquo;</a>
                {% endif %}
            </span>
        </div>
    </div>
</div>
{% endblock %}