{% extends 'base.html' %}
{% load static %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}

<!-- 직원용 대시보드 내용 -->
{% comment %} <link rel="stylesheet" href="{% static 'education/css/styles.css' %}"> {% endcomment %}
<div class="dashboard">
    <div class="consultation-container">
        <div class="customer-info">
            <h2>고객 정보</h2>
            <form id="customer-form">
                <ul>
                    <li>
                        <label for="customer-name">고객명</label>
                        <input type="text" id="customer-name" name="customer-name" disabled>
                    </li>
                    <li>
                        <label for="birthdate">생년월일</label>
                        <input type="date" id="birthdate" name="birthdate" disabled>
                    </li>
                    <li>
                        <label for="phone">전화번호</label>
                        <input type="tel" id="phone" name="phone" disabled>
                    </li>
                    <li>
                        <label for="address">주소</label>
                        <input type="text" id="address" name="address" disabled>
                    </li>
                    <li>
                        <label for="join-date">가입일</label>
                        <input type="date" id="join-date" name="join-date" disabled>
                    </li>
                </ul>
                <div class="buttons">
                    <input type="button" class="edit-button" value="수정" onclick="editCustomerInfo()">
                    <input type="button" class="save-button" value="저장" onclick="saveCustomerInfo()" style="display: none;">
                    <input type="reset" class="save-button" value="초기화" style="display: none;">
                    <input type="button" class="cancel-button" value="취소" onclick="cancelEdit()" style="display: none;">
                </div>
            </form>
        </div>        
        <div class="stt-content">
            <h2>상담내용 변환 창</h2>
            <div class="stt">
                <input type="button" id="start-button" value="마이크 연결">
                <input type="button" id="stop-button" value="마이크 연결 끊기" disabled>
                <div id="transcription">여기에 음성 입력 내용이 표시됩니다...</div>
            </div>
            <div class="recommended-answer">추천 응대 멘트</div>
        </div>
        <div class="memo-section">
            <h2>메모창</h2>
            <div class="memo-content">
                <p>메모장</p>
            </div>
        </div>
        <div class="consultation-content">
            <h2>문의/조치 내용</h2>
            <div class="memo-content">
                <div class="memo-block">문의 내용</div>
                <div class="memo-block">조치 내용</div>
            </div>
        </div>
    </div>
</div>

<script>
    function editCustomerInfo() {
        const form = document.getElementById('customer-form');
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => input.disabled = false);

        document.querySelector('.edit-button').style.display = 'none';
        document.querySelectorAll('.save-button, .cancel-button').forEach(button => {
            button.style.display = 'inline-block';
        });
    }

    function saveCustomerInfo() {
        const form = document.getElementById('customer-form');
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => input.disabled = true);

        // Add logic to save customer info, e.g., sending data to the server
        alert('고객 정보가 저장되었습니다.');

        document.querySelector('.edit-button').style.display = 'inline-block';
        document.querySelectorAll('.save-button, .cancel-button').forEach(button => {
            button.style.display = 'none';
        });
    }

    function cancelEdit() {
        const form = document.getElementById('customer-form');
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => input.disabled = true);

        // Add logic to handle canceling the edit, e.g., reverting changes
        alert('수정이 취소되었습니다.');

        document.querySelector('.edit-button').style.display = 'inline-block';
        document.querySelectorAll('.save-button, .cancel-button').forEach(button => {
            button.style.display = 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const transcription = document.getElementById('transcription');
    
        let mediaRecorder;
        let fullAudioChunks = [];
        let audioStream;
        let interval;
    
        startButton.addEventListener('click', () => {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioStream = stream;
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.start();
    
                    interval = setInterval(() => {
                        if (mediaRecorder.state === 'recording') {
                            mediaRecorder.requestData();
                        }
                    }, 5000);  // 5초마다 데이터 요청
    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            // fullAudioChunks에 현재 청크를 추가
                            fullAudioChunks.push(event.data);
    
                            // 청크 데이터의 길이 로그 출력
                            console.log('Audio chunk size:', event.data.size);
    
                            // 청크 데이터를 비동기적으로 전송
                            sendAudioChunk(event.data);
                        }
                    };
    
                    startButton.disabled = true;
                    stopButton.disabled = false;
                })
                .catch(error => {
                    console.error('Error accessing media devices.', error);
                });
        });
    
        stopButton.addEventListener('click', () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
    
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
    
            clearInterval(interval);
    
            const fullAudioBlob = new Blob(fullAudioChunks, { type: 'audio/webm' });
            fullAudioChunks = [];
    
            const formData = new FormData();
            formData.append('audio', fullAudioBlob);
    
            fetch('/counseling/stt_chat/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                if (data.output) {
                    transcription.innerHTML += '<br>Final Output: ' + data.output;
                } else if (data.error) {
                    transcription.innerHTML += 'Error: ' + data.error + '<br>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                transcription.innerHTML += 'Error: ' + error.message + '<br>';
            });
    
            startButton.disabled = false;
            stopButton.disabled = true;
        });
    
        function sendAudioChunk(chunk) {
            const formData = new FormData();
            formData.append('audio', chunk);
    
            fetch('/counseling/stt/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                if (data.text) {
                    transcription.innerHTML += data.text + '<br>';
                } else if (data.error) {
                    transcription.innerHTML += 'Error: ' + data.error + '<br>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                transcription.innerHTML += 'Error: ' + error.message + '<br>';
            });
        }
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

<style>
    .consultation-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 20px;
    }

    .customer-info, .stt-content, .memo-section, .consultation-content {
        border: 1px solid #ccc;
        padding: 20px;
        box-shadow: 2px 2px 12px #aaa;
        border-radius: 8px;
    }

    .customer-info {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
    }

    .stt-content {
        grid-column: 2 / 3;
        grid-row: 1 / 2;
    }

    .memo-section {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
    }

    .consultation-content {
        grid-column: 2 / 3;
        grid-row: 2 / 3;
    }
</style>

{% endblock %}
