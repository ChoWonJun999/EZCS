{% extends 'base.html' %}

{% block title %}Education Dashboard{% endblock %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'education/css/styles.css' %}">

<div class="dashboard">
    <div class="top-section">
        <div class="top-block">제목</div>
        <div class="top-block">제목</div>
    </div>
    <div class="sections">
        <div class="section chat-section">
            <div class="chat-header">민서님 요청사항</div>
            <!-- 위의 HTML 코드를 여기에 삽입합니다 -->
            <div class="chat-container">
                <div id="chat-content" class="chat-box" style="white-space: pre-line;"><!--줄바꿈-->
                    <!-- 메시지가 여기에 추가됩니다 -->
                </div>
                <div class="category-select">
                    <select id="category" class="form-select">
                        <option value="모바일 > 부가서비스">부가서비스</option>
                        <option value="모바일 > 서비스정책">서비스정책</option>
                        <option value="모바일 > 요금관련">요금관련</option>
                    </select>
                    <button id="select-button" onclick="selectCategory()">선택</button>
                </div>
                <form id="chat-form" action="/education/" method="post" onsubmit="sendMessage(event)">
                    {% csrf_token %}
                    <div class="input-container">
                        <textarea id="question" name="message" placeholder="message..." oninput="autoResize.call(this)"></textarea>
                        <button id="text-button" type="submit">Send</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="section chat-section-readonly">
            <div class="chat-header">읽기 전용 채팅창</div>
            <div class="chat-messages" id="chat-messages-readonly">
                <!-- 채팅 메시지들이 여기에 표시됩니다. -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    let selectedCategory = null;

    function selectCategory() {
        selectedCategory = document.getElementById('category').value;
        console.log('Selected category:', selectedCategory);

        const formData = new FormData();
        formData.append('category', selectedCategory);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        fetch('/education/', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log('Chatbot initialized:', data);
                appendMessage('bot', data.initial_question); // 첫 질문 출력
            })
            .catch(error => console.error('Error:', error));
    }

    function sendMessage(event) {
        event.preventDefault();
        const userInput = document.getElementById('question').value;
        if (!userInput.trim()) return;

        // Append user message to chat box
        appendMessage('user', userInput);

        // Send user message to server
        const formData = new FormData();
        formData.append('message', userInput);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        fetch('/education/chat/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                // Append bot response to chat box
                appendMessage('bot', data.response);
            })
            .catch(error => console.error('Error:', error));
    }

    function appendMessage(sender, message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message ' + sender;
        messageElement.innerHTML = message.split('\n').map(line => `<div>${line}</div>`).join('');
        document.getElementById('chat-content').appendChild(messageElement);
        document.getElementById('question').value = '';
        document.getElementById('chat-content').scrollTop = document.getElementById('chat-content').scrollHeight;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById("question").addEventListener("keydown", function (event) {
        if (event.keyCode === 13 && !event.shiftKey) {
            event.preventDefault();
            document.getElementById("text-button").click();
        }
    });
</script>

{% endblock %}